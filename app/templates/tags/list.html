{% extends "base.html" %}
{% set active_nav = "tags" %}

{% block title %}Tags — Music Library{% endblock %}
{% block topbar_title %}Gestion des tags{% endblock %}

{% block content %}
<div class="d-flex gap-3" style="align-items: flex-start; flex-wrap: wrap;">
  <!-- Tag list -->
  <div class="flex-1" style="min-width: 400px;">
    <div class="filter-bar">
      <select id="categoryFilter"
              onchange="filterTags(this.value)">
        <option value="">Toutes les catégories</option>
        {% for cat in categories %}
        <option value="{{ cat.slug }}">{{ cat.label }}</option>
        {% endfor %}
      </select>
      <div class="flex-1"></div>
      <span class="text-muted text-sm">{{ tags|length }} tag{{ 's' if tags|length != 1 else '' }}</span>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Catégorie</th>
            <th>Valeur</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="tagTableBody">
          {% for tag in tags %}
          <tr data-category="{{ tag.category }}">
            <td>
              <span class="badge badge-surface">
                <i class="mdi mdi-tag" style="color: {{ cat_colors.get(tag.category, 'var(--primary)') }};"></i>
                {{ cat_labels.get(tag.category, tag.category) }}
              </span>
            </td>
            <td>{{ tag.value | capitalize }}</td>
            <td class="text-right">
              <button class="btn btn-outline btn-sm btn-icon"
                      hx-delete="/api/v1/tags/{{ tag.id }}"
                      hx-confirm="Supprimer le tag « {{ cat_labels.get(tag.category, tag.category) }}:{{ tag.value | capitalize }} » ?"
                      hx-target="closest tr"
                      hx-swap="outerHTML"
                      title="Supprimer">
                <i class="mdi mdi-delete"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Side panel -->
  <div style="min-width: 300px; max-width: 350px; display: flex; flex-direction: column; gap: 1rem;">

    <!-- Add tag form -->
    <div class="card">
      <div class="card-body">
        <h3 class="mb-3"><i class="mdi mdi-tag-plus"></i> Nouveau tag</h3>
        <form method="POST" action="/tags">
          <div class="form-group">
            <label class="form-label">Catégorie</label>
            <select name="category" class="form-control" required>
              {% for cat in categories %}
              <option value="{{ cat.slug }}">{{ cat.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Valeur</label>
            <input type="text" name="value" class="form-control" required
                   placeholder="ex: calme, papa, soirée…">
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="mdi mdi-plus"></i> Ajouter
          </button>
        </form>
      </div>
    </div>

    <!-- Category management -->
    <div class="card">
      <div class="card-body">
        <h3 class="mb-3"><i class="mdi mdi-shape"></i> Catégories</h3>

        <!-- Existing categories -->
        <div class="mb-3" id="categoryList">
          {% for cat in categories %}
          <div style="margin-bottom: .75rem;" id="cat-{{ cat.slug }}">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div>
                <span class="badge badge-surface">
                  <i class="mdi mdi-tag" style="color: {{ cat.color or 'var(--primary)' }};"></i>
                  {{ cat.label }}
                </span>
                <div class="text-muted text-sm" style="margin-top: .15rem;">
                  {{ cat.slug }} ({{ cat.tags|length }} tag{{ 's' if cat.tags|length != 1 else '' }})
                </div>
              </div>
              <div class="d-flex align-center gap-1">
                <form method="POST" action="/tags/categories" class="d-flex align-center gap-1">
                  <input type="hidden" name="slug" value="{{ cat.slug }}">
                  <input type="hidden" name="label" value="{{ cat.label }}">
                  <select name="color"
                          class="form-control form-control-sm"
                          title="Couleur de la catégorie"
                          style="min-width: 170px;"
                          onchange="this.form.submit()">
                    {% for key, label, hex in tag_color_choices %}
                    <option value="{{ hex }}"
                      {% if (cat.color or '#03a9f4') == hex %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </form>

                {% if cat.tags|length == 0 %}
                <button class="btn btn-outline btn-sm btn-icon"
                        hx-delete="/tags/categories/{{ cat.slug }}"
                        hx-confirm="Supprimer la catégorie « {{ cat.label }} » ?"
                        hx-target="#cat-{{ cat.slug }}"
                        hx-swap="outerHTML"
                        title="Supprimer">
                  <i class="mdi mdi-delete"></i>
                </button>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <hr style="border-color: var(--border); margin: .75rem 0;">

        <!-- Add / update category form -->
        <form method="POST" action="/tags/categories">
          <div class="form-group">
            <label class="form-label">Identifiant (slug)</label>
            <input type="text" name="slug" class="form-control" required
                   pattern="[a-z][a-z0-9_]*"
                   placeholder="ex: ambiance, public_cible"
                   title="Lettres minuscules, chiffres et underscores">
          </div>
          <div class="form-group">
            <label class="form-label">Libellé</label>
            <input type="text" name="label" class="form-control" required
                   placeholder="ex: Ambiance, Public cible">
          </div>
          <div class="form-group">
            <label class="form-label">Couleur</label>
            <select name="color" class="form-control" required>
              {% for key, label, hex in tag_color_choices %}
              <option value="{{ hex }}" {% if hex == '#03a9f4' %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <div class="text-muted text-sm mt-1">Optionnel: tu peux aussi mettre à jour une catégorie existante en réutilisant son slug.</div>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="mdi mdi-content-save"></i> Enregistrer la catégorie
          </button>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterTags(category) {
  const rows = document.querySelectorAll('#tagTableBody tr');
  rows.forEach(row => {
    if (!category || row.dataset.category === category) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}
</script>
{% endblock %}
